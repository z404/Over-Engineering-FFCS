{% extends 'base.html' %}
{% load static %}
{% block title %}Choose filters{% endblock title %}
{% block head %}
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
{% endblock head %}
{% block content %}
<h1>This is the filter page</h1>
  {% comment 'i don\'t know why we still have display but okay will delete later' %}{{ display }}{% endcomment %}
  <form method="post" action="{% url 'savefilters' %}"  class="ajax form-group">
    {% csrf_token %}
    <hr>
    <input type="radio" name="pre-post-lunch" id="none" value="none" checked>
    <label for="none">Any of these is fine!</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="pre-lab-post-theory" value="pre-lab-post-theory">
    <label for="pre-lab-post-theory">I want all <b>lab</b> classes to be <b>before</b> lunch and all <b>theory</b> classes to be <b>after</b> lunch</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="pre-theory-post-lab" value="pre-theory-post-lab">
    <label for="pre-theory-post-lab">I want all <b>lab</b> classes to be <b>after</b> lunch and all <b>theory</b> classes to be <b>before</b> lunch</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="pre-theory" value="pre-theory">
    <label for="pre-theory">Only want all <b>theory</b> classes be <b>before</b> lunch</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="pre-lab" value="pre-lab">
    <label for="pre-lab">Only want all <b>lab</b> classes be <b>before</b> lunch</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="post-theory" value="post-theory">
    <label for="post-theory">Only want all <b>theory</b> classes be <b>after</b> lunch</label>
    <br>
    <input type="radio" name="pre-post-lunch" id="post-lab" value="post-lab">
    <label for="post-lab">Only want all <b>lab</b> classes be <b>after</b> lunch</label>
    <br>
    <hr>
    <p>Maximum number of:</p>
    <label for="8-classes">8 am 'o' clock classes: </label>
    <input type="number" name="8-classes" id="8-classes" min="0" max="5" value="5">
    <br>
    <label for="2-classes">2 pm 'o' clock classes: </label>
    <input type="number" name="2-classes" id="2-classes" min="0" max="5" value="5">
    <br>
    <label for="6-classes">6 pm 'o' clock classes: </label>
    <input type="number" name="6-classes" id="6-classes" min="0" max="5" value="5">
    <br>
    <hr>
    <div class="form-group">
      <label for="slots" class="form-control-label">Enter the slots you want to eliminate for sure:</label>
      <input type="text" name="slots" id="slots" placeholder="A1, A2, B2, C1, D2 ..." class="form-control">
      <h5 id="error-message" class="invalid-feedback">**Format of slots entered is wrong, please try again</h5>
    </div>
    <hr>
    <input type="submit" id="pre-check" class="btn btn-info" value="Pre check"/>
    <input type="submit" id="save-filters" value="Save these filters" class="btn btn-primary"/>
  </form>
  <div id="pre-check-info" class="paragraph">
  </div>
  <script type="text/javascript">
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  $(document).ready(function () {
    $('#error-message').hide();
    $('input#pre-check').on('click',function(){
    var that=$('form.ajax'),
    url="{% url 'precheck' %}",
    type=that.attr('method'),
    data={};
    const linearSearch = (val) =>{
      const arr='A1 F1 D1 TB1 TG1 L1 L2 L3 L4 L5 L6 B1 G1 E1 TC1 TAA1 L7 L8 L9 L10 L11 L12 C1 A1 F1 V1 V2 L13 L14 L15 L16 L17 L18 D1 B1 G1 TE1 TCC1 L19 L20 L21 L22 L23 L24 E1 C1 TA1 TF1 TD1 L25 L26 L27 L28 L29 L30 A2 F2 D2 TB2 TG2 L31 L32 L33 L34 L35 L36 B2 G2 E2 TC2 TAA2 L37 L38 L39 L40 L41 L42 C2 A2 F2 TD2 TBB2 L43 L44 L45 L46 L47 L48 D2 B2 G2 TE2 TCC2 L49 L50 L51 L52 L53 L54 E2 C2 TA2 TF2 TDD2 L55 L56 L57 L58 L59 L60 V7 V6 V5 V4 V3'.split(' ');
      for(var i=0;i<arr.length;i++){
        if(arr[i]===val)
          return true;
      }
      return false;
    }
    const validList = strng =>{
      lst=strng.toUpperCase().split(',').filter(e=>e!==' ').map(e=>e.trim());
      return lst
    }
    const ValidForm = () => {
      const that = $('input[name=slots]')
      if((that.val().length!=0 && validList(that.val()).length=== validList(that.val()).map(linearSearch).filter(e=>e).length && validList(that.val()).length !== 0)|| (that.val().length == 0)){
        $('#error-message').hide();
        $('#slots').removeClass('is-invalid');
        return true;}
      else {
        $('#error-message').show();
        $('#slots').addClass('is-invalid');
      }
    }
    if(ValidForm()){
    that.find('input[type=radio]:checked,input[type=number],input[type=text]').each((index, valv)=>{
      var that=$(valv),
        name=that.attr('name'),
        id=that.attr('id'),
        value=that.val();
      // console.log(id,value);
      if(name=='category')
        data[id]=value;
      else{
        data[name]=value;
      }
    });
    // console.log(data);
    fetch("{% url 'precheck' %}", {
        method: 'POST',
        'body': JSON.stringify(data),
        headers: {
            'Content-type': 'application/json; charset=UTF-8',
            'X-CSRFToken': csrftoken
        }
    }).then(
      response => response.json()
    ).then(json => {
        console.log(json);
        $("#pre-check-info").text(JSON.stringify(json));
    });
  }
    event.preventDefault();
    
  });
  });
      
    
  </script>
{% endblock content %}